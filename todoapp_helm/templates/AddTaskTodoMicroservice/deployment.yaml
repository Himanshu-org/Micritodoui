apiVersion: apps/v1
kind: Deployment
metadata:
  name: {{ .Values.addtask.name }}
  labels:
    tier: {{ .Values.addtask.tier }}
    app: {{ .Values.addtask.app }}
spec:
  replicas: {{ .Values.addtask.replicas }}
  selector:
    matchExpressions:
    - key: tier 
      values: 
      - {{ .Values.addtask.tier }}
      operator: In
  template:
    metadata:
      labels:
        tier: {{ .Values.addtask.tier }}
    spec:
      tolerations:         # Give toleration power so that pod will schedule to that Node because it has taint
      - key: sku
        operator: Equal
        value: gpu
        effect: PreferNoSchedule
      affinity:
        nodeAffinity:      # Pod will schedule according to below role
          preferredDuringSchedulingIgnoredDuringExecution:
          - weight: 1      # Give highest weight (1-100) more the weight more chances pod will scheduleto that prefrence
            preference:
              matchExpressions:
              - key: project
                operator: In
                values:
                - {{ .Values.addtask.app }}
        podAntiAffinity:   #By this rule 2 two are not created on same node with matchexpression
          requiredDuringSchedulingIgnoredDuringExecution:
          - labelSelector:
              matchExpressions:
              - key: project
                operator: In
                values: 
                - {{ .Values.addtask.app }}
            topologyKey: topology.kubernetes.io/region  
      containers:
      - image: "{{ .Values.addtask.acrname }}.azurecr.io/{{ .Values.addtask.image }}:{{ .Values.addtask.version }}"
        name: {{ .Values.addtask.containerName }}
        env:
        - name: CONNECTION_STRING
          value: "Driver={ODBC Driver 17 for SQL Server};Server=tcp:mssql-latesttodo.database.windows.net,1433;Database=db-latesttodo;Uid=azure;Pwd=d5Va*=5j4c0rlaFa;Encrypt=yes;TrustServerCertificate=no;Connection Timeout=30;"
        ports:
        - containerPort: {{ .Values.addtask.containerPort }}
        resources:
          limits:
            cpu: {{ .Values.addtask.cpuLimit }}
            memory:  {{ .Values.addtask.memoryLimit }}
          requests:
            cpu: {{ .Values.addtask.cpuRequest }}
            memory: {{ .Values.addtask.memoryRequest }}
          

    
